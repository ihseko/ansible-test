---
- name: Update apt cache.
  apt:
    update_cache: yes
    cache_valid_time: 3600
  changed_when: False

- name: Pre-Clean older stuff.
  apt:
    autoclean: "{{ apt_autoclean }}"
    autoremove: "{{ apt_autoremove }}"

- name: Update all packages.
  apt:
    upgrade: "{{ apt_upgrade }}"

- name: Prepare for additional drivers
  apt:
    name: ubuntu-drivers-common

  
- name: Install or update additional drivers
  command: /usr/bin/ubuntu-drivers autoinstall
  when: ubuntu_drivers_autoinstall|bool


- name: Post-Clean older stuff.
  apt:
    autoclean: "{{ apt_autoclean }}"
    autoremove: "{{ apt_autoremove }}"

- name: Remove useless packages from the cache
  apt:
    autoclean: "{{ apt_autoclean }}"

- name: Remove dependencies that are no longer required
  apt:
    autoremove: "{{ apt_autoremove }}"

- name: Is it a dual-boot system with rEFInd
  stat: 
    path: /usr/sbin/refind-mkdefault
  register: refind_script

- name: Make rEFInd the default Boot Manager
  command:
    cmd: /usr/sbin/refind-mkdefault
  when: refind_script.stat.exists

- name: Check if reboot is required
  stat: path=/var/run/reboot-required get_md5=no
  register: file

- name: Reboot server (new kernel)
  reboot:
    pre_reboot_delay: 60
    post_reboot_delay: 60
    test_command: uptime
    reboot_timeout: 300
    connect_timeout: 10
  when: force_reboot or ( do_reboot and file.stat.exists )