---

- name: Update all packages
  yum:
    name: '*'
    security: "{{ yum_security }}"
    state: 'latest'

- name: Remove old stuff - NB only RedHat vers. 7+
  yum:
    autoremove: "{{ yum_autoremove }}"

- name: Install yum-utils to test if reboot is needed
  yum:
    name: 'yum-utils'
    state: 'installed'

- name: Test if machine needs restarting
  command: "needs-restarting -r"
  register: needs_restarting
  ignore_errors: true
  changed_when: false

- debug:
    var: needs_restarting.stdout

- name: Reboot server (new kernel)
  reboot:
    pre_reboot_delay: 60
    post_reboot_delay: 120
    test_command: uptime
    reboot_timeout: 300
    connect_timeout: 10
  when: force_reboot or ( do_reboot and ( needs_restarting.rc == 1 ))
